<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Agent SDK Generator</title>
  <style>
    :root {
      --primary: #780000;
      --primary-hover: #C1121F;
      --bg: #003049;
      --card: #004466;
      --border: #669BBC;
      --text: #FDF0D5;
      --text-muted: #669BBC;
      --success: #669BBC;
      --danger: #C1121F;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
      }
    }

    h1 {
      grid-column: 1 / -1;
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1.75rem;
    }

    h1 span {
      color: var(--primary);
    }

    .panel {
      background: var(--card);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .panel h2 {
      font-size: 1.1rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--text-muted);
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg);
      border: none;
      border-radius: 8px;
      color: var(--text);
      font-size: 0.875rem;
      font-family: inherit;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    textarea#prompt {
      min-height: 240px;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.5rem;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--bg);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .checkbox-item:hover {
      background: #005577;
    }

    .checkbox-item input {
      accent-color: var(--primary);
    }

    .checkbox-item span {
      font-size: 0.8rem;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border);
      transition: 0.3s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--success);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

    .toggle-switch input:disabled + .toggle-slider {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Tool Grid */
    .tool-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .tool-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 0.75rem;
      background: var(--bg);
      border-radius: 8px;
      transition: opacity 0.2s;
    }

    .tool-item.disabled {
      opacity: 0.4;
      pointer-events: none;
    }

    .tool-item .tool-name {
      font-size: 0.85rem;
      font-weight: 500;
    }

    /* All Allow Toggle */
    .all-toggle {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, #004466 0%, #003049 100%);
      border-radius: 8px;
    }

    .all-toggle span {
      font-weight: 600;
      color: #FDF0D5;
    }

    .radio-group {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .radio-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg);
      border-radius: 6px;
      cursor: pointer;
    }

    .radio-item input {
      accent-color: var(--primary);
    }

    .subagent-entry {
      background: var(--bg);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 0.75rem;
    }

    .subagent-entry .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .subagent-entry input,
    .subagent-entry select {
      padding: 0.5rem;
    }

    .subagent-entry textarea {
      min-height: 60px;
      margin-bottom: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.2s;
    }

    .btn-primary {
      background: #FDF0D5;
      color: #003049;
    }

    .btn-primary:hover {
      background: #e8dcc2;
    }

    .btn-secondary {
      background: #669BBC;
      color: #003049;
    }

    .btn-secondary:hover {
      background: #7aadd0;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-add {
      margin-top: 0.5rem;
    }

    .btn-generate {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      font-weight: 600;
      margin-top: 1rem;
    }

    .output-panel {
      display: flex;
      flex-direction: column;
      align-self: stretch;
    }

    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .output-actions {
      display: flex;
      gap: 0.5rem;
    }

    #output {
      background: #002233;
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.8rem;
      line-height: 1.6;
      overflow: auto;
      max-height: 1200px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .hljs-keyword { color: #C1121F; }
    .hljs-string { color: #FDF0D5; }
    .hljs-comment { color: #669BBC; }
    .hljs-number { color: #669BBC; }
    .hljs-property { color: #d2a8ff; }
    .hljs-function { color: #ffa657; }

    .section-title {
      font-size: 0.9rem;
      color: #FDF0D5;
      margin: 1.5rem 0 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-title::before {
      content: '';
      flex: 1;
      height: 1px;
      background: transparent;
    }

    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: transparent;
    }

    .copied {
      animation: flash 0.3s;
    }

    @keyframes flash {
      0% { background: var(--success); }
      100% { background: var(--primary); }
    }

    .tooltip {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .next-steps {
      margin-top: 1.5rem;
      margin-bottom: 1.5rem;
      padding: 1rem 1.25rem;
      background: linear-gradient(135deg, #004466 0%, #003049 100%);
      border-radius: 10px;
    }

    .next-steps h3 {
      font-size: 0.95rem;
      margin-bottom: 0.75rem;
      color: var(--text);
    }

    .next-steps ol {
      margin: 0 0 0.75rem 1.25rem;
      padding: 0;
    }

    .next-steps li {
      font-size: 0.85rem;
      margin-bottom: 0.4rem;
      color: var(--text-muted);
    }

    .next-steps code {
      background: var(--bg);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.8rem;
      color: #FDF0D5;
    }

    .next-steps .note {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin: 0;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Claude Agent SDK <span>Generator</span></h1>

    <div class="panel form-panel">
      <h2>è¨­å®š</h2>

      <!-- åŸºæœ¬è¨­å®š -->
      <div class="form-group">
        <label for="filename">ãƒ•ã‚¡ã‚¤ãƒ«å</label>
        <input type="text" id="filename" value="my_agent.mjs" placeholder="my_agent.mjs">
      </div>

      <div class="form-group">
        <label for="prompt">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆã‚¿ã‚¹ã‚¯ã®æŒ‡ç¤ºï¼‰</label>
        <textarea id="prompt" placeholder="Claudeã«å®Ÿè¡Œã•ã›ãŸã„ã‚¿ã‚¹ã‚¯ã‚’è¨˜è¿°...">å…¬é–‹APIã‚’ä½¿ã£ãŸãƒ‡ãƒ¼ã‚¿ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰Webã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€ã‚¹ãƒ†ãƒƒãƒ—1: APIèª¿æŸ»ã€‘
ã¾ãšWebSearchãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ã€ä»¥ä¸‹ã®æ¡ä»¶ã‚’æº€ãŸã™é¢ç™½ã„å…¬é–‹APIã‚’3ã¤æ¢ã—ã¦ãã ã•ã„ï¼š
- èªè¨¼ä¸è¦ï¼ˆAPIã‚­ãƒ¼ä¸è¦ï¼‰
- CORSå¯¾å¿œï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥å‘¼ã³å‡ºã›ã‚‹ï¼‰
- ç„¡æ–™ã§ä½¿ãˆã‚‹
- ãƒ‡ãƒ¼ã‚¿ãŒè¦–è¦šçš„ã«è¡¨ç¤ºã—ã‚„ã™ã„

è¦‹ã¤ã‘ãŸAPIã«ã¤ã„ã¦ã€ãã‚Œãã‚Œç°¡å˜ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

ã€ã‚¹ãƒ†ãƒƒãƒ—2: å®Ÿè£…ã€‘
é¸ã‚“ã 3ã¤ã®APIã‚’ä½¿ã£ã¦ã€ä»¥ä¸‹ã®æ§‹æˆã§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆï¼š
- index.htmlï¼ˆãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ï¼‰
- css/style.cssï¼ˆã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆï¼‰
- js/app.jsï¼ˆãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ãƒ»APIå‘¼ã³å‡ºã—ï¼‰

æ©Ÿèƒ½è¦ä»¶:
1. 3ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§å„APIã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
2. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
3. ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒœã‚¿ãƒ³
4. ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
5. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³

ãƒ–ãƒ©ã‚¦ã‚¶ã§index.htmlã‚’ç›´æ¥é–‹ã„ã¦å‹•ä½œç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
å¤–éƒ¨CDNã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä½¿ç”¨ã›ãšã€ç´”ç²‹ãªHTML/CSS/JavaScriptã®ã¿ã§å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

ã€ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ†ã‚¹ãƒˆã€‘
ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ï¼ˆnode -c js/app.jsç­‰ï¼‰ã‚’å®Ÿè¡Œã—ã€ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚</textarea>
      </div>

      <div class="form-group">
        <label for="systemPrompt">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå½¹å‰²è¨­å®šï¼‰</label>
        <textarea id="systemPrompt" placeholder="Claudeã®æŒ¯ã‚‹èˆã„ã‚„å½¹å‰²ã‚’å®šç¾©...">ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã™ã‚‹å ´åˆã¯ã€å¿…ãšã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª(./)ã«ç›¸å¯¾ãƒ‘ã‚¹ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚</textarea>
      </div>

      <!-- æ¨©é™è¨­å®š -->
      <div class="section-title">æ¨©é™è¨­å®š</div>

      <div class="form-group">
        <label>Permission Mode</label>
        <div class="radio-group">
          <label class="radio-item">
            <input type="radio" name="permissionMode" value="bypassPermissions" checked>
            <span>bypassPermissionsï¼ˆç¢ºèªã‚¹ã‚­ãƒƒãƒ—ï¼‰</span>
          </label>
          <label class="radio-item">
            <input type="radio" name="permissionMode" value="default">
            <span>defaultï¼ˆç¢ºèªã‚ã‚Šï¼‰</span>
          </label>
        </div>
      </div>

      <!-- ãƒ„ãƒ¼ãƒ«è¨­å®š -->
      <div class="section-title">ãƒ„ãƒ¼ãƒ«è¨­å®š</div>

      <div class="form-group">
        <div class="all-toggle">
          <label class="toggle-switch">
            <input type="checkbox" id="allowAllTools" checked>
            <span class="toggle-slider"></span>
          </label>
          <span>ã™ã¹ã¦è¨±å¯</span>
        </div>
        <p class="tooltip">ONã®å ´åˆ allowedTools ã‚’æŒ‡å®šã›ãšå…¨ãƒ„ãƒ¼ãƒ«ä½¿ç”¨å¯èƒ½ã€‚OFFã«ã™ã‚‹ã¨å€‹åˆ¥ã«è¨±å¯/ç¦æ­¢ã‚’è¨­å®šã€‚</p>

        <div class="tool-grid" id="toolGrid">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
      </div>

      <!-- ã‚¹ã‚­ãƒ«è¨­å®š -->
      <div class="section-title">ã‚¹ã‚­ãƒ«è¨­å®š</div>

      <div class="form-group">
        <label>settingSourcesï¼ˆã‚¹ã‚­ãƒ«èª­ã¿è¾¼ã¿å…ƒï¼‰</label>
        <div class="checkbox-group">
          <label class="checkbox-item"><input type="checkbox" id="settingProject" value="project"><span>project</span></label>
          <label class="checkbox-item"><input type="checkbox" id="settingUser" value="user" checked><span>user</span></label>
        </div>
        <p class="tooltip">project: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†… .claude/skills/ ã‹ã‚‰ã‚¹ã‚­ãƒ«ã‚’èª­ã¿è¾¼ã‚€<br>user: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ›ãƒ¼ãƒ  ~/.claude/skills/ ã‹ã‚‰ã‚¹ã‚­ãƒ«ã‚’èª­ã¿è¾¼ã‚€</p>
      </div>

      <!-- ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­å®š -->
      <div class="section-title">ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆã‚«ã‚¹ã‚¿ãƒ ï¼‰</div>

      <div id="subagentsList"></div>
      <button class="btn btn-secondary btn-add" onclick="addSubagent()">+ ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¿½åŠ </button>

      <!-- è©³ç´°è¨­å®š -->
      <div class="section-title">è©³ç´°è¨­å®š</div>

      <div class="form-group">
        <div class="all-toggle">
          <label class="toggle-switch">
            <input type="checkbox" id="interactiveMode" checked>
            <span class="toggle-slider"></span>
          </label>
          <span>å¯¾è©±ãƒ¢ãƒ¼ãƒ‰</span>
        </div>
        <p class="tooltip">ONã«ã™ã‚‹ã¨ã€AskUserQuestionãƒ„ãƒ¼ãƒ«ã§CLIã‹ã‚‰è³ªå•ã«å›ç­”ã§ãã¾ã™</p>
      </div>

      <div class="form-group">
        <label for="maxTurns">maxTurnsï¼ˆæœ€å¤§ã‚¿ãƒ¼ãƒ³æ•°ï¼‰</label>
        <input type="text" id="maxTurns" placeholder="30">
        <p class="tooltip">ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ç”¨ã€‚æœªå…¥åŠ›ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</p>
      </div>

      <div class="form-group">
        <label for="cwd">ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆcwdï¼‰</label>
        <input type="text" id="cwd" value="path.join(__dirname, 'workspace')" placeholder="__dirnameï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰">
        <p class="tooltip">ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã€‚workspace/ ã§ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚’éš”é›¢</p>
      </div>

      <div class="form-group">
        <label for="executable">Nodeå®Ÿè¡Œãƒ‘ã‚¹ï¼ˆexecutableï¼‰</label>
        <input type="text" id="executable" placeholder="nodeï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰">
        <p class="tooltip">nvmç­‰ã‚’ä½¿ç”¨æ™‚ã« node ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ãƒ•ãƒ«ãƒ‘ã‚¹ã‚’æŒ‡å®šï¼ˆä¾‹: /Users/xxx/.nvm/versions/node/v20.10.0/bin/nodeï¼‰</p>
      </div>

    </div>

    <div class="panel output-panel">
      <button class="btn btn-primary btn-generate" onclick="download()">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (.mjs)</button>

      <div class="next-steps">
        <h3>ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h3>
        <ol>
          <li>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ</li>
          <li>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ <code>.mjs</code> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®</li>
          <li>ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ãã®ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•</li>
          <li>åˆå›ã®ã¿: <code>npm init -y && npm i @anthropic-ai/claude-agent-sdk</code></li>
          <li>å®Ÿè¡Œ: <code>node my_agent.mjs</code></li>
        </ol>
        <p class="note">â€» åˆå›å®Ÿè¡Œæ™‚ã¯ <code>workspace/</code> ãƒ•ã‚©ãƒ«ãƒ€ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã™<br>
        â€» Claude CodeãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãªã‚‰èªè¨¼ã¯è‡ªå‹•ã§è¡Œã‚ã‚Œã¾ã™</p>
      </div>
      <div class="output-header">
        <h2>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
        <button class="btn btn-secondary" onclick="copyToClipboard()">ã‚³ãƒ”ãƒ¼</button>
      </div>
      <pre id="output"></pre>
    </div>
  </div>

  <script>
    const TOOLS = [
      { id: 'Read', name: 'Read', desc: 'ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼' },
      { id: 'Write', name: 'Write', desc: 'ãƒ•ã‚¡ã‚¤ãƒ«æ›¸è¾¼' },
      { id: 'Edit', name: 'Edit', desc: 'ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†' },
      { id: 'Glob', name: 'Glob', desc: 'ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œç´¢' },
      { id: 'Grep', name: 'Grep', desc: 'å†…å®¹æ¤œç´¢' },
      { id: 'Bash', name: 'Bash', desc: 'ã‚·ã‚§ãƒ«å®Ÿè¡Œ' },
      { id: 'WebSearch', name: 'WebSearch', desc: 'Webæ¤œç´¢' },
      { id: 'WebFetch', name: 'WebFetch', desc: 'Webå–å¾—' },
      { id: 'Task', name: 'Task', desc: 'ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ' },
      { id: 'Skill', name: 'Skill', desc: 'ã‚¹ã‚­ãƒ«å®Ÿè¡Œ' },
      { id: 'TodoWrite', name: 'TodoWrite', desc: 'ã‚¿ã‚¹ã‚¯ç®¡ç†' },
      { id: 'NotebookEdit', name: 'NotebookEdit', desc: 'Jupyterç·¨é›†' },
    ];

    function initToolGrid() {
      const grid = document.getElementById('toolGrid');
      grid.innerHTML = TOOLS.map(tool => `
        <div class="tool-item" data-tool="${tool.id}">
          <span class="tool-name">${tool.name}</span>
          <label class="toggle-switch">
            <input type="checkbox" data-tool-toggle="${tool.id}" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
      `).join('');

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
      grid.querySelectorAll('input[data-tool-toggle]').forEach(input => {
        input.addEventListener('change', generate);
      });

      updateToolGridState();
    }

    function updateToolGridState() {
      const allowAll = document.getElementById('allowAllTools').checked;
      const items = document.querySelectorAll('.tool-item');

      items.forEach(item => {
        if (allowAll) {
          item.classList.add('disabled');
          item.querySelector('input').checked = true;
        } else {
          item.classList.remove('disabled');
        }
      });
    }

    // localStorageæ“ä½œ
    const STORAGE_KEY = 'casui_settings';

    // è¨­å®šã‚’ä¿å­˜
    function saveSettings() {
      const settings = {
        filename: document.getElementById('filename').value,
        prompt: document.getElementById('prompt').value,
        systemPrompt: document.getElementById('systemPrompt').value,
        permissionMode: document.querySelector('input[name="permissionMode"]:checked')?.value,
        allowAllTools: document.getElementById('allowAllTools').checked,
        toolToggles: {},
        settingProject: document.getElementById('settingProject').checked,
        settingUser: document.getElementById('settingUser').checked,
        interactiveMode: document.getElementById('interactiveMode').checked,
        maxTurns: document.getElementById('maxTurns').value,
        cwd: document.getElementById('cwd').value,
        executable: document.getElementById('executable').value,
        subagents: getSubagents()
      };

      // ãƒ„ãƒ¼ãƒ«ãƒˆã‚°ãƒ«ã®çŠ¶æ…‹ã‚’ä¿å­˜
      document.querySelectorAll('input[data-tool-toggle]').forEach(input => {
        settings.toolToggles[input.dataset.toolToggle] = input.checked;
      });

      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
      } catch (e) {
        console.warn('è¨­å®šã®ä¿å­˜ã«å¤±æ•—:', e);
      }
    }

    // è¨­å®šã‚’å¾©å…ƒ
    function loadSettings() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) return;

      try {
        const settings = JSON.parse(saved);

        if (settings.filename) document.getElementById('filename').value = settings.filename;
        if (settings.prompt) document.getElementById('prompt').value = settings.prompt;
        if (settings.systemPrompt) document.getElementById('systemPrompt').value = settings.systemPrompt;

        if (settings.permissionMode) {
          const radio = document.querySelector(`input[name="permissionMode"][value="${settings.permissionMode}"]`);
          if (radio) radio.checked = true;
        }

        if (typeof settings.allowAllTools === 'boolean') {
          document.getElementById('allowAllTools').checked = settings.allowAllTools;
        }

        if (typeof settings.settingProject === 'boolean') {
          document.getElementById('settingProject').checked = settings.settingProject;
        }
        if (typeof settings.settingUser === 'boolean') {
          document.getElementById('settingUser').checked = settings.settingUser;
        }

        if (typeof settings.interactiveMode === 'boolean') {
          document.getElementById('interactiveMode').checked = settings.interactiveMode;
        }

        if (settings.maxTurns) document.getElementById('maxTurns').value = settings.maxTurns;
        if (settings.cwd) document.getElementById('cwd').value = settings.cwd;
        if (settings.executable) document.getElementById('executable').value = settings.executable;

        // ãƒ„ãƒ¼ãƒ«ãƒˆã‚°ãƒ«ã‚’å¾©å…ƒ
        if (settings.toolToggles) {
          setTimeout(() => {
            for (const [toolId, checked] of Object.entries(settings.toolToggles)) {
              const input = document.querySelector(`input[data-tool-toggle="${toolId}"]`);
              if (input) input.checked = checked;
            }
            updateToolGridState();
          }, 0);
        }

        // ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å¾©å…ƒ
        if (settings.subagents && Object.keys(settings.subagents).length > 0) {
          for (const [id, config] of Object.entries(settings.subagents)) {
            addSubagent();
            const entry = document.querySelector('.subagent-entry:last-child');
            if (entry) {
              entry.querySelector('[data-field="id"]').value = id;
              entry.querySelector('[data-field="description"]').value = config.description || '';
              entry.querySelector('[data-field="prompt"]').value = config.prompt || '';
              entry.querySelector('[data-field="model"]').value = config.model || 'haiku';
            }
          }
        }
      } catch (e) {
        console.warn('è¨­å®šã®å¾©å…ƒã«å¤±æ•—:', e);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initToolGrid();
      loadSettings();

      document.getElementById('allowAllTools').addEventListener('change', () => {
        updateToolGridState();
        generate();
        saveSettings();
      });

      // å…¥åŠ›å¤‰æ›´æ™‚ã«è‡ªå‹•ç”Ÿæˆï¼†ä¿å­˜
      document.querySelectorAll('input, textarea, select').forEach(el => {
        el.addEventListener('input', () => { generate(); saveSettings(); });
        el.addEventListener('change', () => { generate(); saveSettings(); });
      });

      // åˆæœŸç”Ÿæˆ
      updateToolGridState();
      generate();
    });

    let subagentId = 0;

    function addSubagent() {
      const id = subagentId++;
      const container = document.getElementById('subagentsList');
      const entry = document.createElement('div');
      entry.className = 'subagent-entry';
      entry.id = `subagent-${id}`;
      entry.innerHTML = `
        <div class="form-row">
          <input type="text" placeholder="ID (ä¾‹: code-reviewer)" data-field="id">
          <select data-field="model">
            <option value="haiku">haikuï¼ˆé«˜é€Ÿãƒ»ä½ã‚³ã‚¹ãƒˆï¼‰</option>
            <option value="sonnet">sonnetï¼ˆãƒãƒ©ãƒ³ã‚¹ï¼‰</option>
            <option value="opus">opusï¼ˆé«˜æ€§èƒ½ï¼‰</option>
          </select>
          <button class="btn btn-danger" onclick="removeSubagent(${id})">Ã—</button>
        </div>
        <input type="text" placeholder="description (èª¬æ˜)" data-field="description" style="width:100%;margin-bottom:0.5rem;padding:0.5rem;">
        <textarea placeholder="prompt (æŒ‡ç¤º)" data-field="prompt"></textarea>
      `;
      container.appendChild(entry);
      generate();
    }

    function removeSubagent(id) {
      document.getElementById(`subagent-${id}`)?.remove();
      generate();
    }

    function getSubagents() {
      const entries = document.querySelectorAll('.subagent-entry');
      const agents = {};
      entries.forEach(entry => {
        const id = entry.querySelector('[data-field="id"]').value.trim();
        if (!id) return;
        agents[id] = {
          description: entry.querySelector('[data-field="description"]').value.trim(),
          prompt: entry.querySelector('[data-field="prompt"]').value.trim(),
          model: entry.querySelector('[data-field="model"]').value,
        };
      });
      return agents;
    }

    function getToolSettings() {
      const allowAll = document.getElementById('allowAllTools').checked;
      if (allowAll) {
        return { allowedTools: [], disallowedTools: [] };
      }

      const allowedTools = [];
      const disallowedTools = [];

      document.querySelectorAll('input[data-tool-toggle]').forEach(input => {
        const toolId = input.dataset.toolToggle;
        if (input.checked) {
          allowedTools.push(toolId);
        } else {
          disallowedTools.push(toolId);
        }
      });

      return { allowedTools, disallowedTools };
    }

    function getSettingSources() {
      const sources = [];
      if (document.getElementById('settingProject').checked) sources.push('project');
      if (document.getElementById('settingUser').checked) sources.push('user');
      return sources;
    }

    function escapeForTemplate(str) {
      return str.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$');
    }

    function generate() {
      const filename = document.getElementById('filename').value || 'my_agent.mjs';
      const prompt = document.getElementById('prompt').value;
      const systemPrompt = document.getElementById('systemPrompt').value;
      const permissionMode = document.querySelector('input[name="permissionMode"]:checked').value;
      const { allowedTools, disallowedTools } = getToolSettings();
      const settingSources = getSettingSources();
      const agents = getSubagents();
      const maxTurns = document.getElementById('maxTurns').value;
      const cwd = document.getElementById('cwd').value;
      const executable = document.getElementById('executable').value;
      const interactiveMode = document.getElementById('interactiveMode').checked;

      let options = [];

      // cwdãŒpath.joinç­‰ã®å¼ã®å ´åˆã¯ãã®ã¾ã¾ã€æ–‡å­—åˆ—ã®å ´åˆã¯ã‚¯ã‚©ãƒ¼ãƒˆ
      if (cwd) {
        if (cwd.includes('path.') || cwd.includes('__dirname')) {
          options.push(`      cwd: ${cwd},`);
        } else {
          options.push(`      cwd: "${cwd}",`);
        }
      }

      if (systemPrompt) {
        options.push(`      systemPrompt: \`${escapeForTemplate(systemPrompt)}\`,`);
      }

      if (permissionMode === 'bypassPermissions') {
        options.push(`      permissionMode: "bypassPermissions",`);
        options.push(`      allowDangerouslySkipPermissions: true,`);
      } else {
        options.push(`      permissionMode: "default",`);
      }

      // ã™ã¹ã¦è¨±å¯ã§ãªã„å ´åˆã€è¨±å¯ãƒ„ãƒ¼ãƒ«ã‚’ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã¨ã—ã¦å‡ºåŠ›
      if (allowedTools.length > 0 && allowedTools.length < TOOLS.length) {
        options.push(`      allowedTools: [${allowedTools.map(t => `"${t}"`).join(', ')}],`);
      }

      if (settingSources.length > 0) {
        options.push(`      settingSources: [${settingSources.map(s => `"${s}"`).join(', ')}],`);
      }

      if (Object.keys(agents).length > 0) {
        let agentsStr = '      agents: {\n';
        for (const [id, config] of Object.entries(agents)) {
          agentsStr += `        "${id}": {\n`;
          agentsStr += `          description: "${config.description}",\n`;
          agentsStr += `          prompt: \`${escapeForTemplate(config.prompt)}\`,\n`;
          agentsStr += `          model: "${config.model}",\n`;
          agentsStr += `        },\n`;
        }
        agentsStr += '      },';
        options.push(agentsStr);
      }

      if (maxTurns) {
        options.push(`      maxTurns: ${maxTurns},`);
      }

      if (executable) {
        options.push(`      executable: "${executable}",`);
      }

      // å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ç”¨ã®canUseTool
      if (interactiveMode) {
        options.push(`      canUseTool: handleAskUserQuestion,`);
      }

      // path/fileURLToPathãŒå¿…è¦ã‹ã©ã†ã‹
      const needsPath = cwd && (cwd.includes('path.') || cwd.includes('__dirname'));

      let imports = `import { query } from "@anthropic-ai/claude-agent-sdk";`;
      if (interactiveMode) {
        imports += `
import readline from "readline";`;
      }
      if (needsPath) {
        imports += `
import { fileURLToPath } from "url";
import path from "path";
import { mkdirSync, existsSync } from "fs";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);`;
      }

      // cwdãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè‡ªå‹•ä½œæˆã‚³ãƒ¼ãƒ‰
      let mkdirCode = '';
      if (needsPath) {
        mkdirCode = `
  // ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãªã‘ã‚Œã°ä½œæˆ
  const workDir = ${cwd};
  if (!existsSync(workDir)) {
    mkdirSync(workDir, { recursive: true });
    console.log("ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ:", workDir);
  }
`;
      }

      // å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
      let interactiveHelper = '';
      if (interactiveMode) {
        interactiveHelper = `
// ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
function askQuestion(rl, question) {
  return new Promise(resolve => rl.question(question, resolve));
}

// AskUserQuestionãƒ„ãƒ¼ãƒ«ã‚’å‡¦ç†ã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
async function handleAskUserQuestion(toolName, input) {
  if (toolName === "AskUserQuestion") {
    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout
    });

    const answers = {};

    for (const q of input.questions) {
      console.log(\`\\n\${q.header}: \${q.question}\`);
      q.options.forEach((opt, i) => {
        console.log(\`  \${i + 1}. \${opt.label} - \${opt.description}\`);
      });
      console.log(\`  \${q.options.length + 1}. ãã®ä»–ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰\`);

      const answer = await askQuestion(rl, "é¸æŠ (ç•ªå·): ");
      const idx = parseInt(answer) - 1;

      if (idx >= 0 && idx < q.options.length) {
        answers[q.question] = q.options[idx].label;
      } else {
        const custom = await askQuestion(rl, "å…¥åŠ›: ");
        answers[q.question] = custom;
      }
    }

    rl.close();
    return {
      behavior: "allow",
      updatedInput: { ...input, answers }
    };
  }

  return { behavior: "allow", updatedInput: input };
}
`;
      }

      const code = `${imports}${interactiveHelper}

async function main() {
  console.log("Agent é–‹å§‹...\\n");
${mkdirCode}

  const result = query({
    prompt: \`${escapeForTemplate(prompt)}\`,
    options: {
${options.join('\n')}
    },
  });

  for await (const message of result) {
    if (message.type === "assistant") {
      for (const block of message.message.content) {
        if (block.type === "text") {
          console.log(block.text);
        } else if (block.type === "tool_use") {
          console.log(\`\\n[ãƒ„ãƒ¼ãƒ«: \${block.name}]\`);
          const inputStr = JSON.stringify(block.input, null, 2);
          if (inputStr.length > 500) {
            console.log(\`  å…¥åŠ›: \${inputStr.slice(0, 500)}...(çœç•¥)\`);
          } else {
            console.log(\`  å…¥åŠ›: \${inputStr}\`);
          }
        }
      }
    } else if (message.type === "user") {
      // ãƒ„ãƒ¼ãƒ«çµæœã‚’è¡¨ç¤º
      for (const block of message.message.content) {
        if (block.type === "tool_result") {
          const content = block.content;
          let resultStr = typeof content === "string" ? content : JSON.stringify(content);
          if (resultStr.length > 300) {
            resultStr = resultStr.slice(0, 300) + "...(çœç•¥)";
          }
          console.log(\`  çµæœ: \${resultStr}\`);
        }
      }
    } else if (message.type === "result") {
      console.log("\\n--- çµæœ ---");
      console.log("æˆåŠŸ:", message.subtype === "success");
      console.log("ã‚¿ãƒ¼ãƒ³æ•°:", message.num_turns);
      console.log("ã‚³ã‚¹ãƒˆ (USD):", message.total_cost_usd?.toFixed(4));
      console.log("ä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³:", message.usage);
    }
  }
}

main().catch(console.error);
`;

      document.getElementById('output').innerHTML = highlightJS(code);
      // ç”Ÿã®ã‚³ãƒ¼ãƒ‰ã‚’ä¿æŒï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚³ãƒ”ãƒ¼ç”¨ï¼‰
      document.getElementById('output').dataset.rawCode = code;
    }

    function highlightJS(code) {
      // 1. HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
      let result = code
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // 2. è¡Œã”ã¨ã«å‡¦ç†ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      result = result.split('\n').map(line => {
        // ã‚³ãƒ¡ãƒ³ãƒˆè¡Œï¼ˆè¡Œé ­ã‹ã‚‰ã®//ï¼‰
        if (/^\s*\/\//.test(line)) {
          return `<span class="hljs-comment">${line}</span>`;
        }
        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã§æ–‡å­—åˆ—ã‚’ä¸€æ™‚é€€é¿
        const strings = [];
        line = line.replace(/("(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')/g, (match) => {
          strings.push(match);
          return `__STRING_${strings.length - 1}__`;
        });
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        line = line.replace(/\b(import|export|from|async|await|function|const|let|var|for|if|else|return|true|false|null)\b/g,
          '<span class="hljs-keyword">$1</span>');
        // æ•°å­—
        line = line.replace(/\b(\d+)\b/g, '<span class="hljs-number">$1</span>');
        // æ–‡å­—åˆ—ã‚’å¾©å…ƒã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        line = line.replace(/__STRING_(\d+)__/g, (_, idx) => {
          return `<span class="hljs-string">${strings[idx]}</span>`;
        });
        return line;
      }).join('\n');

      return result;
    }

    function copyToClipboard() {
      const code = document.getElementById('output').dataset.rawCode;
      navigator.clipboard.writeText(code);
      const btn = document.querySelector('.output-actions .btn-secondary');
      btn.textContent = 'ã‚³ãƒ”ãƒ¼æ¸ˆã¿!';
      btn.classList.add('copied');
      setTimeout(() => {
        btn.textContent = 'ã‚³ãƒ”ãƒ¼';
        btn.classList.remove('copied');
      }, 1500);
    }

    function download() {
      const code = document.getElementById('output').dataset.rawCode;
      const filename = document.getElementById('filename').value || 'my_agent.mjs';
      const blob = new Blob([code], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

  </script>
</body>
</html>

# 08: Claude 4.5 ネイティブサブエージェント

## 概要

Claude 4.5モデルは、明示的なサブエージェント定義（`agents`オプション）なしでも、
組み込みの`Task`ツールを使って自律的にサブエージェントを起動できる。

## 組み込みサブエージェントタイプ

SDKには以下のサブエージェントタイプが組み込まれている:

| タイプ | 用途 |
|--------|------|
| `Explore` | コードベース探索、ファイル検索、構造分析 |
| `Plan` | 実装計画の立案、アーキテクチャ設計 |
| `general-purpose` | 汎用的なマルチステップタスク |

## 04との違い

| 項目 | 04_subagents | 08_native_subagents |
|------|--------------|---------------------|
| agents定義 | 必要（カスタム定義） | 不要（組み込み使用） |
| サブエージェントタイプ | 独自定義可能 | 組み込みタイプのみ |
| モデル指定 | エージェントごとに指定可 | 自動選択 |
| 柔軟性 | 高い | 手軽 |

## サンプルコード (`08_native_subagents.mjs`)

```javascript
import { query } from "@anthropic-ai/claude-agent-sdk";

async function main() {
  const result = query({
    prompt: `
このプロジェクトについて、以下の分析を行ってください：
1. プロジェクト構造の分析
2. 依存パッケージの調査
3. コードパターンの特定
`,
    options: {
      systemPrompt: `あなたはプロジェクト分析のエキスパートです。
複雑なタスクは、Taskツールを使って専門的なサブエージェントに委任できます。
サブエージェントタイプには以下があります:
- Explore: コードベース探索用
- Plan: 実装計画立案用
- general-purpose: 汎用的なタスク用`,
      permissionMode: "bypassPermissions",
      allowDangerouslySkipPermissions: true,
      // agents オプションは定義しない（組み込みを使用）
    },
  });

  for await (const message of result) {
    // Task ツールの使用を観察
  }
}
```

## 実行結果

```
=== 08: Claude 4.5 ネイティブサブエージェントデモ ===

分析を開始します。3つのタスクは独立しているので、並行して実行します。

[ツール使用: Task]
  タイプ: Explore
  説明: プロジェクト構造の分析

[ツール使用: Task]
  タイプ: Explore
  説明: 依存パッケージの調査

[ツール使用: Task]
  タイプ: Explore
  説明: コードパターンの特定

（各サブエージェントが並列で調査を実行）

# プロジェクト概要レポート
## プロジェクト名: Claude Agent SDK Test
- 9つのデモスクリプト
- 充実した日本語ドキュメント
- SDK機能の段階的な学習設計

--- サブエージェント使用統計 ---
Taskツール呼び出し回数: 3

使用されたサブエージェント:
  - Explore: 3回

--- 結果 ---
成功: true
ターン数: 4
コスト (USD): 0.4251
```

## ポイント

1. **自律的な判断**: モデルが独自にサブエージェントの必要性を判断
2. **並列起動**: 3つのExploreエージェントが同時に起動（1メッセージ内で3つのTask呼び出し）
3. **適切なタイプ選択**: 分析タスクに対して`Explore`タイプを自動選択
4. **結果の統合**: 各サブエージェントの結果を統合してレポートを生成

## システムプロンプトのガイダンス

モデルがサブエージェントを使用するよう促すには、システムプロンプトで言及する:

```javascript
systemPrompt: `複雑なタスクは、Taskツールを使ってサブエージェントに委任できます。
サブエージェントタイプ:
- Explore: コードベース探索
- Plan: 実装計画
- general-purpose: 汎用タスク`
```

## コスト比較

| デモ | サブエージェント | コスト |
|------|-----------------|--------|
| 04 (カスタム定義) | 6個（code-quality×5 + security-auditor×1） | $0.43 |
| 08 (ネイティブ) | 3個（Explore×3） | $0.43 |

→ サブエージェント数に応じてコストが増加する傾向

## ユースケース

| ケース | 推奨アプローチ |
|--------|---------------|
| 特定ドメインの専門エージェントが必要 | 04 (カスタム定義) |
| 汎用的な探索・計画タスク | 08 (ネイティブ) |
| コストを抑えたい | サブエージェントを使わない単純なクエリ |
